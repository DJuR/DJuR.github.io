---
title: postgres笔记
author: DJuR
date: 2021-11-04
tags: SQL
category: Database
layout: post
---

* content
{:toc}

> postgres相关使用笔记记录。


<!--more-->

psql的使用
-----------------

* 基本命令参数

```shell
psql --help
  -h, --host=HOSTNAME      database server host or socket directory (default: "local socket")
  -p, --port=PORT          database server port (default: "5432")
  -U, --username=USERNAME  database user name (default: "djuru")
  -w, --no-password        never prompt for password
  -W, --password           force password prompt (should happen automatically)
```


* 在`linux`安装环境，进入`postgres`用户，可已`postgres`用户模式登录

```shell
psql [-d 数据库]
```

* mac环境或者连接远程服务

```shell
psql -h host地址 -p 端口  -U 账户 -d 数据库 
```

* 交互模式导出导入数据

```postgresql
-- 列出所有数据库
\l

-- 切换数据库
\c 数据库名

-- 从数据库copy到文件
\copy (sql语句) to '存储文件' with csv | binary;

-- 从文件copy到数据库
\copy 表(字段1，字段2，...) from '存储文件' with csv | binary;

-- 将查询导出到csv文件 数据量大会执行时间很长 700万数据，执行3分钟左右
\copy (查询语句) to '文件路径' with csv;

-- 将csv数据导入到数据库
\copy schema.table(filed1,...) from '文件路径' with csv;
```

* psql远程执行sql

```shell
psql -h host -p port -d database -U username -c "\copy (select id,name from schema.user) to '/tmp/user.csv' with csv;"
```

pg_dump 的使用
-----------------

> pg_dump可以执行数据库、schema、表的备份，导出等操作
> 

## 导出数据

```shell
pg_dump -h 地址 -p 端口号 -U 账号 -d 数据库 -n schema名 -Fc 导出格式 > 文件
```

* -F
  * P plain
    输出一个纯文本形式的SQL脚本文件（默认值）。
  * c custom
    输出一个适合于作为pg_restore输入的自定义格式归档。
  * d directory
    输出一个适合作为pg_restore输入的目录格式归档。
  * t tar
    输出一个适合于输入到pg_restore中的tar-格式归档。
* -j 
  执行并发导出，只能和`-Fd`一起操作。

  

后记 （项目升级数据同步）
-----------------

> 项目升级，数据库表结构发生变化，单表数据又过大，数据导出速度慢等问题。

### 问题处理
1. 数据量大，sql查询慢，存在group by操作，通过`explain`查看执行计划进行分析
2. 查询条件和groupBy语句添加索引，或者构建中间临时表。
3. 通过`pd_dum`和`pg_restore`工具配合处理

参考资料
-----------------

[postgres官方文档](http://www.postgres.cn/docs/13/reference-client.html)
